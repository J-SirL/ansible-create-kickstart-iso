# Generated by Anaconda 34.25.3.8
# Generated by pykickstart v3.32
#version=RHEL9

# Use graphical install
graphical
repo --name="AppStream" --baseurl=file:///run/install/sources/mount-0000-cdrom/AppStream

%addon com_redhat_kdump --enable --reserve-mb='auto'
%end

# Keyboard layouts
keyboard --xlayouts='se'
# System language
lang en_GB.UTF-8


# Use CDROM installation media
cdrom

%packages
@^server-product-environment
@headless-management
@remote-system-management
@system-tools
%end

# Run the Setup Agent on first boot
firstboot --enable

# System timezone
timezone Europe/Stockholm --utc

#Root password
rootpw --lock
user --groups=wheel --name={{ ks_user }} --password={{ ks_pass }} --iscrypted --gecos="Johan SÃ¶rell"

# Disk Detection and Dynamic Partitioning Scheme
%pre
# Detect the primary disk type
PRIMARY_DISK=$(lsblk -d -o name,rota | awk '$2=="0"{print $1; exit}')

# Determine disk type and create a partition layout file accordingly
if [[ $PRIMARY_DISK == nvme* ]]; then
    # NVMe disk detected
    cat > /tmp/partition_layout << EOF
ignoredisk --only-use=nvme0n1
clearpart --none --initlabel
part /boot --fstype="xfs" --ondisk=nvme0n1 --size=1024
part /boot/efi --fstype="efi" --ondisk=nvme0n1 --size=512
part pv.1050 --fstype="lvmpv" --ondisk=nvme0n1 --grow --size=1 --maxsize=100000
volgroup almalinux_developer --pesize=4096 pv.1050
logvol swap --fstype="swap" --size=16384 --name=swap --vgname=almalinux_developer
logvol /home --fstype="xfs" --percent=30 --name=home --vgname=almalinux_developer
logvol / --fstype="xfs" --percent=29.9 --name=root --vgname=almalinux_developer
logvol /opt --fstype="xfs" --percent=40 --name=opt --vgname=almalinux_developer
EOF
else
    # SATA disk detected
    cat > /tmp/partition_layout << EOF
ignoredisk --only-use=vda
clearpart --none --initlabel
# Define your SATA disk partitioning scheme here
# For example:
part /boot --fstype="xfs" --ondisk=vda --size=1024
part /boot/efi --fstype="efi" --ondisk=vda --size=512
part pv.sata --fstype="lvmpv" --ondisk=vda --grow --size=1 --maxsize=100000
volgroup almalinux_developer --pesize=4096 pv.sata
logvol swap --fstype="swap" --size=16384 --name=swap --vgname=almalinux_developer
logvol /home --fstype="xfs" --percent=30 --name=home --vgname=almalinux_developer
logvol / --fstype="xfs" --percent=29 --name=root --vgname=almalinux_developer
logvol /opt --fstype="xfs" --percent=40 --name=opt --vgname=almalinux_developer
EOF
fi
%end

# Include the dynamic partition layout
%include /tmp/partition_layout

%post
#!/bin/bash

# Detect the primary network interface
PRIMARY_IF=$(ip -br link | awk '$0 !~ "lo|vir|wl|^[^0-9]"{print $1;getline}')
echo "Detected primary interface: $PRIMARY_IF"

# Create a NetworkManager profile for the detected interface
nmcli con add type ethernet con-name $PRIMARY_IF ifname $PRIMARY_IF

# Configure the network interface to use DHCP and activate it
nmcli con mod $PRIMARY_IF ipv4.method auto ipv6.method auto connection.autoconnect yes

# Set the hostname
hostnamectl set-hostname virtualOne.sitedevelopments.lan

# Apply the network changes
nmcli con up $PRIMARY_IF

%end

